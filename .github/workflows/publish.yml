name: Publicar en NPM

on:
  push:
    branches:
      - main

jobs:
  publicar:
    name: Publicar Librer√≠a
    runs-on: ubuntu-latest

    # Permisos OBLIGATORIOS para Trusted Publishers
    permissions:
      contents: write
      issues: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Actualizar NPM
        run: npm install -g npm@latest

      - name: Instalar dependencias
        run: npm install

      # üí• PASO CLAVE: Inyectar configuraci√≥n en package.json
      # Usamos un script de Node para asegurar que el JSON sea v√°lido y se aplique correctamente.
      # Esto configura 'verifyConditions: false' para evitar el error ENONPMTOKEN
      # y asegura 'provenance: true' para que funcione Trusted Publishers.
      - name: Configurar package.json para Release
        run: |
          node -e '
            const fs = require("fs");
            const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
            
            // 1. Asegurar Provenance (OIDC)
            pkg.publishConfig = { ...pkg.publishConfig, access: "public", provenance: true };
            
            // 2. Configurar Semantic Release para saltar verificaci√≥n de token
            pkg.release = {
              branches: ["main"],
              plugins: [
                "@semantic-release/commit-analyzer",
                "@semantic-release/release-notes-generator",
                "@semantic-release/github",
                ["@semantic-release/npm", { "verifyConditions": false }],
                "@semantic-release/git"
              ]
            };
            
            fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2));
            console.log("package.json actualizado con configuraci√≥n de release.");
          '

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 24
          # Aseguramos que los plugins necesarios est√©n instalados en el entorno
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/github 
            @semantic-release/npm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NPM_TOKEN eliminado para usar Trusted Publishers
